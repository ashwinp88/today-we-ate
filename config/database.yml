# PostgreSQL configuration for Today We Ate
# Development and test use local databases by default but can be overridden
# with DEV_DATABASE_URL / TEST_DATABASE_URL. Production expects DATABASE_URL
# (and optional *_DATABASE_URL overrides for cache/queue/cable roles).
<%
  production_primary_url = ENV["DATABASE_URL"] || ENV["BUILD_DATABASE_URL"]
  production_cache_url = ENV["CACHE_DATABASE_URL"] || production_primary_url
  production_queue_url = ENV["QUEUE_DATABASE_URL"] || production_primary_url
  production_cable_url = ENV["CABLE_DATABASE_URL"] || production_primary_url

  if production_primary_url.blank? && (ENV["RAILS_ENV"] == "production" || ENV["RACK_ENV"] == "production")
    raise "DATABASE_URL must be set in production and BUILD_DATABASE_URL during builds"
  end

  production_primary_url ||= "postgresql://localhost/today_we_ate_production"
  production_cache_url ||= production_primary_url
  production_queue_url ||= production_primary_url
  production_cable_url ||= production_primary_url
%>

default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS", 5) %>
  variables:
    statement_timeout: 5000

development:
  <<: *default
  url: <%= ENV.fetch("DEV_DATABASE_URL", "postgresql://localhost/today_we_ate_development") %>

test:
  <<: *default
  url: <%= ENV.fetch("TEST_DATABASE_URL", "postgresql://localhost/today_we_ate_test") %>

production:
  primary:
    <<: *default
    url: <%= production_primary_url %>
  cache:
    <<: *default
    url: <%= production_cache_url %>
    migrations_paths: db/cache_migrate
  queue:
    <<: *default
    url: <%= production_queue_url %>
    migrations_paths: db/queue_migrate
  cable:
    <<: *default
    url: <%= production_cable_url %>
    migrations_paths: db/cable_migrate

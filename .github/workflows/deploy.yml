name: Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    name: Build & Deploy
    environment: production
    runs-on:
      - self-hosted
      - linux
      - home
    env:
      DOCKER_BUILDKIT: "1"
      COMPOSE_PROJECT_NAME: today_we_ate
      POSTGRES_USER: ${{ secrets.POSTGRES_USER || vars.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD || vars.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB || vars.POSTGRES_DB }}
      POSTGRES_DATA_PATH: ${{ secrets.POSTGRES_DATA_PATH || vars.POSTGRES_DATA_PATH }}
      POSTGRES_INITDB_ARGS: ${{ secrets.POSTGRES_INITDB_ARGS || vars.POSTGRES_INITDB_ARGS }}
      DATABASE_URL: ${{ format('postgresql://{0}:{1}@db:5432/{2}', secrets.POSTGRES_USER || vars.POSTGRES_USER, secrets.POSTGRES_PASSWORD || vars.POSTGRES_PASSWORD, secrets.POSTGRES_DB || vars.POSTGRES_DB) }}
      BUILD_DATABASE_URL: ${{ format('postgresql://{0}:{1}@db:5432/{2}', secrets.POSTGRES_USER || vars.POSTGRES_USER, secrets.POSTGRES_PASSWORD || vars.POSTGRES_PASSWORD, secrets.POSTGRES_DB || vars.POSTGRES_DB) }}
    steps:
      - name: Verify required configuration
        run: |
          : "${POSTGRES_USER:?POSTGRES_USER is required}"
          : "${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}"
          : "${POSTGRES_DB:?POSTGRES_DB is required}"
          : "${POSTGRES_DATA_PATH:?POSTGRES_DATA_PATH is required}"
          : "${POSTGRES_INITDB_ARGS:?POSTGRES_INITDB_ARGS is required}"
          : "${DATABASE_URL:?DATABASE_URL is required}"
          : "${BUILD_DATABASE_URL:?BUILD_DATABASE_URL is required}"
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate production env file
        run: |
          cat <<'ENVFILE' > .env.production
          RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }}
          POSTGRES_USER=${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ env.POSTGRES_DB }}
          POSTGRES_DATA_PATH=${{ env.POSTGRES_DATA_PATH }}
          POSTGRES_INITDB_ARGS=${{ env.POSTGRES_INITDB_ARGS }}
          WEB_PORT=${{ vars.WEB_PORT || '3000' }}
          WEB_CONCURRENCY=${{ vars.WEB_CONCURRENCY || '2' }}
          DATABASE_URL=${{ env.DATABASE_URL }}
          ENVFILE
          chmod 600 .env.production

      - name: Build image
        env:
          BUILD_DATABASE_URL: ${{ env.BUILD_DATABASE_URL }}
        run: docker compose build --pull web

      - name: Ensure database is running
        run: docker compose up -d db

      - name: Run migrations
        run: docker compose run --rm web ./bin/rails db:migrate

      - name: Deploy application
        run: docker compose up -d --remove-orphans web

      - name: Show services
        run: docker compose ps

      - name: Cleanup dangling artifacts
        run: docker image prune -f
        continue-on-error: true
